name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get diff
        id: diff
        run: |
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI review
        id: ai
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const { Configuration, OpenAIApi } = require("openai");
            const openai = new OpenAIApi(new Configuration({
              apiKey: process.env.OPENAI_API_KEY
            }));

            const diff = `\`\`\`diff\n${process.env.DIFF_CONTENT}\n\`\`\``;

            const prompt = `
              You are a senior backend engineer.
              Review the following PR diff and provide:
              - bugs or risky changes
              - improvement suggestions
              - code smells
              - readability concerns

              ${diff}
            `;

            const response = await openai.createChatCompletion({
              model: "gpt-4o-mini",
              messages: [{ role: "user", content: prompt }]
            });

            return { review: response.data.choices[0].message.content };

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: context.payload.pull_request.title + "\n\n" + "${{ steps.ai.outputs.review }}"
            })
        env:
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
