name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # 1) Repo checkout + full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Generate diff between PR base and head
      - name: Get diff
        id: diff
        run: |
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3) Install OpenAI SDK
      - name: Install OpenAI SDK
        run: |
          npm init -y
          npm install openai

      # 4) Generate AI review using Node.js
      - name: Run AI Code Review
        id: ai_review
        run: |
          node << 'EOF'
          const { OpenAI } = require("openai");
          const fs = require("fs");

          const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
          const diff = process.env.DIFF_CONTENT;

          const prompt = `
          You are a senior backend engineer reviewing a GitHub Pull Request.
          Provide a clear code review in Markdown.

          Here is the PR diff:
          \`\`\`diff
          ${diff}
          \`\`\`
          `;

          async function main() {
            const res = await client.chat.completions.create({
              model: "gpt-4o-mini",
              messages: [{ role: "user", content: prompt }],
            });

            const review = res.choices[0].message.content;

            //
            // ---- ðŸ”¥ GitHub Output Safe Write ----
            //
            // !! ì—¬ê¸°ì—ì„œ ${review} ê°™ì€ ì¹˜í™˜ë¬¸ìž ì—†ìŒ !!
            // Node ë³€ìˆ˜(review)ë¥¼ ì§ì ‘ ë¬¸ìžì—´ë¡œ í•©ì³ íŒŒì¼ì— ì”€.
            //

            const out = [
              "REVIEW_OUTPUT<<EOF",
              review,
              "EOF"
            ].join("\n");

            fs.appendFileSync(process.env.GITHUB_OUTPUT, out);
          }

          main();
          EOF

      # 5) Comment on the PR
      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          REVIEW_OUTPUT: ${{ steps.ai_review.outputs.REVIEW_OUTPUT }}
        with:
          script: |
            const review = process.env.REVIEW_OUTPUT;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ðŸ¤– AI Code Review\n\n${review}`
            });
