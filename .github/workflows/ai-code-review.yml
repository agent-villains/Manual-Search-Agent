name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        id: diff
        run: |
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install OpenAI SDK
        run: |
          npm init -y
          npm install openai

      - name: Run AI Code Review
        id: ai_review
        run: |
          node << 'EOF'
          const { OpenAI } = require("openai");
          const fs = require("fs");

          const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
          const diff = process.env.DIFF_CONTENT;

          const prompt = `
          Please write the entire review in Korean.
          You are a senior backend engineer reviewing a GitHub Pull Request.

          \`\`\`diff
          ${diff}
          \`\`\`
          `;

          async function main() {
            const res = await client.chat.completions.create({
              model: "gpt-4o-mini",
              messages: [{ role: "user", content: prompt }],
            });

            const review = res.choices[0].message.content;

            // ì•ˆì „í•œ multiline output
            const out = [
              "REVIEW_OUTPUT<<EOF",
              review,
              "EOF"
            ].join("\n");

            fs.appendFileSync(process.env.GITHUB_OUTPUT, out);
          }

          main();
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}

      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          REVIEW_OUTPUT: ${{ steps.ai_review.outputs.REVIEW_OUTPUT }}
        with:
          script: |
            const review = process.env.REVIEW_OUTPUT;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ðŸ¤– AI Code Review\n\n${review}`
            });
